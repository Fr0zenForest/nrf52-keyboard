# 通讯协议文档

## UART 通讯协议

### 基础格式

CMD DAT ... DAT SUM

- CMD：命令
- DAT：数据
- SUM：前面所有数据和命令的校验和

其中，根据CMD的不同，DAT的长度可能有所变化。若DAT长度为0，则不需要SUM。

主机(CH554)会定期向从机(nRF52810)发送状态数据包，请求从机上传。

### 主机命令

#### Ping 包与当前状态
```
0b0001 xxxx
       ||||
       |||+--- 上次接收数据是否成功（成功置为1）
       ||+---- 充电状态（充满置为1）
       |+----- 主机状态（与主机连接成功置为1）
       +------ 当前键盘的Protocol
```

无DAT

#### LED 下传
```
0b010x xxxx
     + ++++--- 5Bit的LED状态
```

无DAT

#### Keymap 下传
```
0b1xxx xxxx 
   ||| ||||
   +++-++++--- 当前Keymap分包的ID，从0开始
```

DAT长度为60，存储着Keymap数据

### 从机命令

#### 按键数据包上传
```
0b1aab bbbb 
   ||+ ++++--- 数据包的数据部分长度
   ++--------- 数据包类型: 0: keyboard, 1: consumer, 2: system, 3: nkro keyboard
```

- 对于Keyboard类型数据包，DAT长度为8
- 对于Consumer和System类型数据包，DAT长度为2
- 对于NKRO类型数据包，DAT长度为16

#### Keymap 响应
同 Ping 包与当前状态的格式。0x10为校验和失败，0x11为单包发送成功，0x12为所有包发送完毕

## HID Keymap 下载通讯协议

主机发送：

```
ID DAT[60] SUM
```

- ID: 当前发送的数据分包ID
- DAT: 长度为60的键盘配列包
- SUM: DAT的校验和

从机响应：

- 0x10: 校验和失败，请求重发
- 0x11: 校验和成功，请求发送下一包
- 0x12: 按键包接收完毕，请求停止发送